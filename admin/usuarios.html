<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Admin - Gesti√≥n de Usuarios</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-800">
  <!-- NAVBAR SUPERIOR -->
  <nav class="bg-blue-700 text-white px-6 py-4 flex justify-between items-center shadow-md">
    <h1 class="text-xl font-bold">‚öôÔ∏è Panel de Administraci√≥n</h1>
    <ul class="flex gap-6 text-sm font-medium">
      <li><a href="#" class="hover:text-gray-200 border-b-2 border-transparent hover:border-white">Usuarios</a></li>
      <li><a href="archivos.html" class="hover:text-gray-200 border-b-2 border-transparent hover:border-white">Archivos</a></li>
      <li><a href="#" class="hover:text-gray-200 border-b-2 border-transparent hover:border-white">Configuraci√≥n</a></li>
      <li><button id="cerrarSesion" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded">Cerrar Sesi√≥n</button></li>
    </ul>
  </nav>

  <!-- CONTENEDOR PRINCIPAL -->
  <main class="max-w-5xl mx-auto mt-10 p-6 bg-white rounded-xl shadow-lg">
    <h2 class="text-2xl font-semibold text-blue-600 mb-6">üë• Gesti√≥n de Usuarios</h2>

    <!-- FORMULARIO CREAR USUARIO -->
    <form id="crearUsuarioForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <input type="email" id="email" placeholder="Correo electr√≥nico" required class="border p-2 rounded-lg w-full" />
      <input type="password" id="password" placeholder="Contrase√±a" required class="border p-2 rounded-lg w-full" />
      <select id="rol" class="border p-2 rounded-lg w-full">
        <option value="user">Usuario</option>
        <option value="admin">Administrador</option>
      </select>
      <button type="submit" class="col-span-1 md:col-span-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">‚ûï Crear</button>
    </form>

    <p id="estado" class="text-sm mb-4"></p>

    <!-- TABLA DE USUARIOS -->
    <div class="overflow-x-auto">
      <table class="w-full text-sm border-collapse border border-gray-300">
        <thead class="bg-gray-200">
          <tr>
            <th class="border p-2 text-left">Correo</th>
            <th class="border p-2 text-left">Rol</th>
            <th class="border p-2 text-left">Creado</th>
            <th class="border p-2 text-center">Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaUsuarios">
          <tr><td colspan="4" class="text-center py-4 text-gray-500">‚è≥ Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// üîπ Configuraci√≥n Supabase
const supabase = createClient(
  "https://bkmrymsbcnqrxltsmxxm.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrbXJ5bXNiY25xcnhsdHNteHhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNzM2MTksImV4cCI6MjA3Mzc0OTYxOX0.Z4puY5w_Gb7GbbpipawQQ755MKsJcJUeyra7-XnL5as"
);

const crearUsuarioForm = document.getElementById("crearUsuarioForm");
const tablaUsuarios = document.getElementById("tablaUsuarios");
const estado = document.getElementById("estado");

// üîπ Funci√≥n para cargar usuarios
async function cargarUsuarios() {
  const { data: usuarios, error } = await supabase
    .from("profiles")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    estado.textContent = "‚ùå Error al cargar usuarios: " + error.message;
    estado.style.color = "red";
    return;
  }

  if (!usuarios || usuarios.length === 0) {
    tablaUsuarios.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No hay usuarios registrados.</td></tr>`;
    return;
  }

  tablaUsuarios.innerHTML = "";
  usuarios.forEach(user => {
    tablaUsuarios.innerHTML += `
      <tr>
        <td class="border p-2">${user.email}</td>
        <td class="border p-2">${user.role}</td>
        <td class="border p-2">${new Date(user.created_at).toLocaleString()}</td>
        <td class="border p-2 text-center space-x-2">
          <button class="editar bg-yellow-400 px-2 py-1 rounded" data-id="${user.id}">Editar</button>
          <button class="eliminar bg-red-500 px-2 py-1 rounded text-white" data-id="${user.id}">Eliminar</button>
        </td>
      </tr>
    `;
  });

  // Eventos botones
  document.querySelectorAll(".editar").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      const { data: user } = await supabase.from("profiles").select("*").eq("id", id).maybeSingle();
      if (!user) return alert("Usuario no encontrado");
      const nuevoRol = prompt("Editar rol (admin/user):", user.role);
      if (!nuevoRol) return;
      await supabase.from("profiles").update({ role: nuevoRol }).eq("id", id);
      cargarUsuarios();
    });
  });

  document.querySelectorAll(".eliminar").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      if (!confirm("¬øDeseas eliminar este usuario?")) return;
      await supabase.from("profiles").delete().eq("id", id);
      cargarUsuarios();
    });
  });
}

// üîπ Crear usuario (solo frontend para perfiles, backend debe crear auth)
crearUsuarioForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const role = document.getElementById("rol").value;

  if (!email || !password) return;

  estado.textContent = "‚è≥ Creando usuario...";
  estado.style.color = "gray";

  try {
    // üîπ Aqu√≠ debes llamar al backend que use service role key
    const res = await fetch("/api/registrar-auth", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ correo: email, password, rol: role })
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    estado.textContent = "‚úÖ Usuario creado correctamente";
    estado.style.color = "green";

    crearUsuarioForm.reset();
    cargarUsuarios();
  } catch (err) {
    estado.textContent = "‚ùå Error: " + err.message;
    estado.style.color = "red";
  }
});

// üîπ Inicializar
cargarUsuarios();
  </script>
</body>
</html>
